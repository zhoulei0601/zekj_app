<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>new webview</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<script src="../libs/jquery/jquery-1.8.3.min.js"></script>
		<script src="../js/mui.min.js"></script>
		
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">新窗口</h1>
		</header>
		<div class="mui-content">
			<p style="margin-top:20px;margin-left: 20px;">这是subNView模式下打开的新窗口。</p>
		</div>
	
		<button onclick="choosePhoto(this)">上传</button>
		<img src="" id="pictureId" style="width: 200px;height: 100px;" />

		
		<script>
			mui.init(); 
			function choosePhoto(event) {
				if (mui.os.plus) {
				var a = [{
					title: '拍照'
					}, {
					  title: '从手机相册选择'
					}];
				plus.nativeUI.actionSheet({
					title: '图片上传',
					cancel: '取消',
					buttons: a
					}, function(b) {
					   switch (b.index) {
						  case 0:
							break;
						  case 1:
							  //拍照  
							  getImages(event);
						   break;
						  case 2:
							  //打开相册  
							  galleryImages(event);
							break;
						}
					}, false);
		 
						}
					}
		 
			//拍照  
			function getImages(event) {
				var mobileCamera = plus.camera.getCamera();
				mobileCamera.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var path = entry.toLocalURL() + '?version=' + new Date().getTime();
						uploadHeadImg(path, event);
						console.log(path);
					}, function(err) {
						console.log("读取拍照文件错误");
					});
				}, function(e) {
					console.log("er", err);
				}, function() {
					filename: '_doc/head.png';
				});
			}
		 
			//本地相册选择   
			function galleryImages(event) {
				console.log("你选择了从相册选择");
				plus.gallery.pick(function(a) {
					plus.io.resolveLocalFileSystemURL(a, function(entry) {
						plus.io.resolveLocalFileSystemURL('_doc/', function(root) {
							root.getFile('head.png', {}, function(file) {
								//文件已经存在
								file.remove(function() {
									console.log("文件移除成功");
									entry.copyTo(root, 'head.png', function(e) {
										var path = e.fullPath + '?version=' + new Date().getTime();
										uploadHeadImg(path, event);
									}, function(err) {
										console.log("copy image fail: ", err);
									});
								}, function(err) {
									console.log("删除图片失败：（" + JSON.stringify(err) + ")");
								});
							}, function(err) {
								//打开文件失败
								entry.copyTo(root, 'head.png', function(e) {
									var path = e.fullPath + '?version=' + new Date().getTime();
									uploadHeadImg(path, event);
								}, function(err) {
									console.log("上传图片失败：（" + JSON.stringify(err) + ")");
								});
							});
						}, function(e) {
							console.log("读取文件夹失败：（" + JSON.stringify(err) + ")");
						});
					});
				}, function(err) {
					console.log("读取拍照文件失败: ", err);
				}, {
					filter: 'image'
				});
			};
					
			var container = mui("#progress-bar p");
			var stateText = localStorage.getItem('$token');
			
			//上传图片
			function uploadHeadImg(imgPath, event) {
				//选中图片之后，头像当前的照片变为选择的照片
				var mainImg = event;
				document.getElementById('pictureId').setAttribute('src',imgPath);
				mainImg.src = imgPath;
				
				var image = new Image();
				image.src = imgPath;
 
				image.onload = function() {
					var path='/api/appUser/uploadCheckPhoto';
					var picNum=event.id;
					var base64 = getBase64Image(image);
					var url = '';
					mui.ajax(url,{
						data:{
							'imgDatas':base64
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'post', //HTTP请求类型
						timeout: 25000, //超时时间设置为25秒；
						success: function(data) {
							if (data.code == 0) {
								localStorage.setItem('$head_image',data.src);
								simulateLoading(container,0,100);
								setTimeout(function() {
									//mui.toast(data.msg);
									hint.innerHTML='上传成功';
									hint.style.color="#3CB371";
								},2560);
							}else{
								mui.alert(data.msg);
							}
						},
						error: function(xhr, type, errorThrown) {
							if (type == 'timeout') {
								mui.alert('服务器连接超时，请稍后再试');
							}
						}
					});
				}
			}
		 
		//压缩图片转成base64
		function getBase64Image(img) {
			var w = 1200
			imgWidth = img.width;
			imgHeight = img.height;
			var canvas = document.createElement("canvas");
			var ctx = canvas.getContext("2d");
			if (Math.max(imgWidth, imgHeight) > w) {
				if (imgWidth > imgHeight) {
					canvas.width = w;
					canvas.height = w * imgHeight / imgWidth;
				} else {
					canvas.height = w;
					canvas.width = w * imgWidth / imgHeight;
				}
			} else {
				canvas.width = imgWidth;
				canvas.height = imgHeight;
			}
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
			var dataUrl = canvas.toDataURL("image/png", 0.92);
			return dataUrl;
		}
		
		$(function(){
			console.log(localStorage.getItem("userCode"));
			var url = "http://192.168.1.115:8980/js/a/botgjxhgl/leadershipArrangement/listData";
			mui.ajax(url,
				{
					type: "post",		
					dataType: 'json',
					headers:{ 'contentType' : 'application/x-www-form-urlencoded'},	
					timeout:10000,//超时时间设置为10秒；
					error:function(XMLHttpRequest, textStatus, errorThrown){
						console.error("状态码：" + XMLHttpRequest.status + " ;状态：" + XMLHttpRequest.readyState + " ;错误信息：" + textStatus);
					},
					success: function(data){
						console.log(data);
					},
				}
			);
		});
			
		</script>
	</body>
</html>
